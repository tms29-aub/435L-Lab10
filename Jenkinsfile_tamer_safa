pipeline { 
    agent any
    environment { 
        VIRTUAL_ENV = "${env.WORKSPACE}/venv"
        PYTHON = '/Users/tamersafa/.local/share/virtualenvs/storefront-KWPrtJCG/bin/python3'
    }

    options {
        timeout(time: 3, unit: 'MINUTES') // Set a global timeout for the entire pipeline
    }

    stages {
        stage('Setup') {
            options {
                timeout(time: 2, unit: 'MINUTES') 
            }
            steps {
                script {
                    if (!fileExists("${VIRTUAL_ENV}")) {
                        sh "/bin/bash -c 'python3 -m venv ${VIRTUAL_ENV}'"
                    }
                }
                sh "/bin/bash -c 'source ${VIRTUAL_ENV}/bin/activate && pip install -r requirements.txt'"
            }
        }
        
        stage('Lint') { 
            steps {
                sh "source ${VIRTUAL_ENV}/bin/activate && flake8 app.py"
            }
        }

        stage('Test') { 
            steps {
                sh "source ${VIRTUAL_ENV}/bin/activate && pytest"
            }
        }

        stage('Coverage') {
            steps {
                sh "source ${VIRTUAL_ENV}/bin/activate && coverage run -m pytest"
                sh "source ${VIRTUAL_ENV}/bin/activate && coverage report -m"
                sh "source ${VIRTUAL_ENV}/bin/activate && coverage html" // Generates HTML report
                archiveArtifacts artifacts: 'htmlcov/**', allowEmptyArchive: true
            }
        }

        stage('SecurityScan') {
            steps {
                sh "source ${VIRTUAL_ENV}/bin/activate && bandit -r ."
            }
        }

        stage('Deploy') { 
            steps {
                script {
                    echo "Deploying application..."
                    // Placeholder for deployment steps - replace with actual deployment commands
                    // e.g., ssh, rsync, or scp commands to deploy to a remote server
                    sh "echo 'Deploying to server...'" 
                }
            }
        }
    }

    post { 
        always { 
            cleanWs()
        }
    }
}
